<!-- Page Title -->
<!-- Recent Conversations -->
<div class="conversations">
  <div id="recentMessagesHeader">
    <div class="inbox" ng-click="MessagesCtrl.loadRecentMessages();">
      <i class="fa fa-envelope"></i> Inbox
    </div>
    <div class="add" ng-click="MessagesCtrl.showConvoModal = true">
      <i class="fa fa-plus"></i> New Message
    </div>
  </div>
  <div id="pageConvos" ng-if="MessagesCtrl.pageMax > 0">
    <div class="prev">
      <button ng-click="MessagesCtrl.loadRecentMessages(MessagesCtrl.page - 1)" ng-disabled="MessagesCtrl.page === 1">&#10094;</button>
    </div>
    <div class="page">{{ MessagesCtrl.page }} of {{ MessagesCtrl.pageMax }}</div>
    <div class="next">
      <button ng-click="MessagesCtrl.loadRecentMessages(MessagesCtrl.page + 1)" ng-disabled="MessagesCtrl.page === MessagesCtrl.pageMax">&#10095;</button>
    </div>
  </div>
  <div class="list" ng-if="MessagesCtrl.pageMax > 0">
    <div ng-repeat="message in MessagesCtrl.recentMessages track by message.id" class="cell" ng-click="MessagesCtrl.loadConversation(message.conversation_id)" ng-class="{ 'active': MessagesCtrl.selectedConversationId === message.conversation_id}">
      <strong>To:</strong> {{ message.receiver_username }}<br>
      <strong>From:</strong> {{ message.sender_username }}<br>
      <span class="msg-preview">{{ message.body }}</span>
    </div>
  </div>
</div>

<!-- Current Conversation -->
<div class="messages">
  <!-- New Message -->
  <div ng-if="MessagesCtrl.currentConversation.messages.length > 0" class="thin-underline">
    <h4>Conversation with {{ MessagesCtrl.receiverName }}</h4> {{showReply}}
    <a class="right no-select" ng-click="MessagesCtrl.showReply = !MessagesCtrl.showReply"><i class="fa fa-reply"></i> Reply</a>
  </div>
  <div ng-if="MessagesCtrl.currentConversation.messages.length > 0" class="reply" ng-show="MessagesCtrl.showReply">
    <!-- Messages Receiver -->
    <label>Receiver
      <autocomplete-user-id user-id="MessagesCtrl.newMessage.receiver_id" username="MessagesCtrl.newMessage.receiver_username" ></autocomplete-user-id>
    </label>
    <!-- Message Body and Send button-->
    <label>Message ( <a ng-click="MessagesCtrl.newMessage.preview = !MessagesCtrl.newMessage.preview">Toggle Preview</a> )
      <textarea ng-model="MessagesCtrl.newMessage.body" ng-model-options="{ updateOn: 'default blur', debounce: { 'default': 500, 'blur': 0 } }"></textarea>
      <label ng-show="MessagesCtrl.newMessage.preview">Preview</label>
      <div class="preview" ng-show="MessagesCtrl.newMessage.preview" post-processing="MessagesCtrl.newMessage.previewBody"></div>
    </label>
    <div class="clear">
      <button class="fill-row" ng-click="MessagesCtrl.saveMessage(); MessagesCtrl.showReply = false; MessagesCtrl.newMessage.preview = false;" ng-disabled="!MessagesCtrl.newMessage.body || !MessagesCtrl.newMessage.receiver_id">Send</button>
    </div>
  </div>

  <!-- Conversation Messages -->
  <div class="msg-container">
    <div id="{{message.id}}" ng-repeat="message in MessagesCtrl.currentConversation.messages track by message.id" class="message" ng-class="MessagesCtrl.currentUserId === message.sender_id ? 'sender' : ''">
      <div class="avatar">
       <img ng-if="message.sender_avatar" src="{{message.sender_avatar}}" />
       <img ng-if="!message.sender_avatar" src="https://fakeimg.pl/400x400/ccc/444/?text={{message.sender_username}}" />
      </div>
      <div class="content">
        <div class="title">
          <strong>{{ message.sender_username}}</strong>
          <span class="date">{{ message.created_at | humanDate }}</span>
          <div ng-if="message.sender_id === MessagesCtrl.currentUserId" class="right">
            <a href="#" class="action css-tooltip" ng-click="MessagesCtrl.openDeleteModal(message.id)" data-css-tooltip="Delete">
              <i class="fa fa-trash"></i>
            </a>
          </div>
        </div>
        <div post-processing="message.body" style-fix="true">{{ message.body }}</div>
      </div>
    </div>
  </div>
  <h4 ng-if="MessagesCtrl.currentConversation.messages.length < 1" class="centered-text">
    No Conversation selected <br />
  </h4>

  <!-- load more message -->
  <div class="clear">
    <button class="fill-row" ng-if="MessagesCtrl.hasMoreMessages()" ng-click="MessagesCtrl.loadMoreMessages()">
      Load More Messages
    </button>
  </div>
</div>


<!-- Create New Conversation Modal -->
<modal show="MessagesCtrl.showConvoModal" on-close="MessagesCtrl.closeConvoModal()">
  <form name="$parent.form" class="css-form" novalidate>
    <h3 class="thin-underline">New Message</h3>
    <!-- Select User -->
    <label>To:
      <autocomplete-user-id user-id="MessagesCtrl.newConversation.receiver_id" username="MessagesCtrl.newConversation.receiver_username" ></autocomplete-user-id>
    </label>

    <!-- Message Body -->
    <label>Message:
      <textarea type="text" rows="10" ng-model="MessagesCtrl.newConversation.body"></textarea>
    </label>

    <!-- Save Button -->
    <div class="clear">
      <button class="fill-row" ng-click="MessagesCtrl.createConversation()" ng-disabled="!MessagesCtrl.newConversation.body || !MessagesCtrl.newConversation.receiver_id">
        Start Conversation
      </button>
    </div>
  </form>
</modal>

<!-- Delete Message Modal -->
<modal show="MessagesCtrl.showDeleteModal" on-close="MessagesCtrl.closeDeleteModal()">
  <form name="$parent.form" class="css-form" novalidate>
    <h3 class="thin-underline">Delete Message</h3>
    <p>Are you sure you want to permanently delete this message?</p>

    <!-- Save Button -->
    <div class="clear">
      <button class="fill-row" ng-click="MessagesCtrl.deleteMessage()">
        Delete Message
      </button>
    </div>
  </form>
</modal>
